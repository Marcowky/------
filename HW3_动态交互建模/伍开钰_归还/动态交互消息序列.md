# 动态交互信息序列

### 客户端

```bash
1："用户"参与者将校园卡插入"读卡器"。"读卡器接口"对象读取卡中信息
1.1：校园卡识别成功，"读卡器接口"将"校园卡识别成功"的消息发送给"自助借还机控制"对象，使得"自助借还机控制"状态图从"空闲状态(初始状态)"转移到"验证校园卡未过期"状态。与该转移关联的输出事件是"验证校园卡是否过期"
1.1a：校园卡识别成功，"读卡器接口"将校园卡输入数据(包含了卡号、编号、单位、岗位、有效期)发送给"校园卡"实体对象
1.2："自助借还机控制"将"验证校园卡是否过期"消息发送给"校园卡"对象
1.3：若校园卡未过期，"校园卡"对象将"校园卡未过期"消息(包含校园卡未过期消息、卡号)发送给"自助借还机控制"对象，使得"自助借还机控制"状态图从"验证校园卡未过期"转移到"验证校园卡未挂失"状态。与该转移关联的输出事件是"验证校园卡是否挂失"
1.4："自助借还机控制"向"自助借还服务"发送一个"验证校园卡是否挂失"(包含卡号)的请求
1.5："自助借还服务"验证校园卡未挂失并向"自助借还机控制"发送"校园卡未挂失"的响应，使得"自助借还机控制"状态图从"验证校园卡未挂失"转移到"等待用户选择功能"状态。与该转移关联的输出事件是"显示功能菜单"
1.6, 1.7："自助借还机控制"对象通过"用户交互"对象向"用户键盘/显示器"对象发送"显示功能菜单"消息，将功能菜单显示给用户

2, 2.1："用户"参与者输入"归还"选项，通过"用户交互"对象将"用户选择归还"发送给"自助借还机控制"，使得"自助借还机控制"状态图从"等待用户选择功能"转移到"等待书籍识别"状态。

3*[i:=1, 用户共需归还的书目]："用户"参与者将每本书籍的条形码置于自助借还机的"扫描器"下，"扫描器接口"对象获取书籍信息
3.1：条形码可识别，"扫描器接口"将"条形码识别成功"的消息(包含书籍ISBN)发送给"自助借还机控制"对象，使得"自助借还机控制"状态图从"等待书籍识别"转移到"查询书籍借阅信息"状态。与该转移关联的输出事件是"查询书籍借阅信息"
3.2："自助借还机控制"向"自助借还服务"发送一个"查询书籍借阅信息"(包含书籍ISBN)的请求
3.3："自助借还服务"查询完毕，向"自助借还机控制"发送"书籍借阅信息"的响应(包含书籍ID、书名、借阅者编号、借阅到期时间)，使得"自助借还机控制"状态图从"查询书籍借阅信息"转移到"等待书籍识别"状态。与该转移关联的输出事件是"显示书籍借阅信息"
3.4, 3.5："自助借还机控制"对象通过"用户交互"对象向"用户键盘/显示器"对象发送"显示书籍借阅信息"消息(包含书名、借阅者编号、借阅到期时间)，将书籍借阅信息显示给用户

4："用户"参与者向"用户交互"对象输入"确认"选项
4.1："用户交互"对象将"用户确认归还"发送给"自助借还机控制"，使得"自助借还机控制"状态图从"等待书籍识别"转移到"确认完成归还"状态。与该转移关联的输出事件是"更新书籍借阅信息"、"退卡"和"显示已完成归还"
4.2："自助借还机控制"向"自助借还服务"发送一个"更新书籍借阅信息"(包含借阅者编号、全部的书籍ID)的请求
4.2a, 4.a.1："自助借还机控制"对象通过"用户交互"对象向"用户键盘/显示器"对象发送"显示已完成归还"消息，提示用户已完成归还操作
4.2b, 4.2b.1："自助借还机控制"通过"读卡器接口"向"读卡器"外部I/O设备输出"退卡"消息，完成退卡
4.2b.2："读卡器接口"向"自助借还机控制"发送"卡已退出"消息，使得"自助借还机控制"从"确认完成归还"重新回到"空闲状态"状态。

1.1A：校园卡识别失败，"读卡器接口"将"校园卡识别失败"的消息发送给"自助借还机控制"对象，使得"自助借还机控制"状态图从"空闲状态(初始状态)"转移到"退卡"状态。与该转移关联的输出事件是"退卡"和"显示校园卡无法识别"
1.1A.1, 1.1A.2, 1.1A.1a, 1.1A.1a.1: "自助借还机控制"通过"读卡器接口"向"读卡器"外部I/O设备输出"退卡"消息，完成退卡。与此同时，"自助借还机控制"对象通过"用户交互"对象向"用户键盘/显示器"对象发送"显示校园卡无法识别"消息，提示用户校园卡无法识别
1.1A.3："读卡器接口"向"自助借还机控制"发送"卡已退出"消息，使得"自助借还机控制"从"退卡"重新回到"空闲状态"状态。

1.3A：若校园卡已过期，"校园卡"对象将"校园卡已过期"消息发送给"自助借还机控制"对象，使得"自助借还机控制"状态图从"验证校园卡未过期"转移到"退卡"状态。与该转移关联的输出事件是"退卡"和"显示校园卡已过期验证失败"
1.3A.1, 1.3A.2, 1.3A.1a, 1.3A.1a.1: "自助借还机控制"通过"读卡器接口"向"读卡器"外部I/O设备输出"退卡"消息，完成退卡。与此同时，"自助借还机控制"对象通过"用户交互"对象向"用户键盘/显示器"对象发送"显示校园卡已过期验证失败"(包含"卡已过期")消息，提示用户校园卡已过期
1.3A.3："读卡器接口"向"自助借还机控制"发送"卡已退出"消息，使得"自助借还机控制"从"退卡"重新回到"空闲状态"状态。

1.5A："自助借还服务"验证校园卡已挂失并向"自助借还机控制"发送"校园卡已挂失"的响应，使得"自助借还机控制"状态图从"验证校园卡未挂失"转移到"退卡"状态。与该转移关联的输出事件是"退卡"和"显示校园卡已挂失验证失败"
1.5A.1, 1.5A.2, 1.5A.1a, 1.5A.1a.1: "自助借还机控制"通过"读卡器接口"向"读卡器"外部I/O设备输出"退卡"消息，完成退卡。与此同时，"自助借还机控制"对象通过"用户交互"对象向"用户键盘/显示器"对象发送"校园卡已挂失验证失败"(包含"卡已挂失")消息，提示用户校园卡已挂失
1.5A.3："读卡器接口"向"自助借还机控制"发送"卡已退出"消息，使得"自助借还机控制"从"退卡"重新回到"空闲状态"状态。

3.1A：条形码不可识别，"扫描器接口"将"条形码识别失败"的消息发送给"自助借还机控制"对象，使得"自助借还机控制"状态图从"等待书籍识别"转移到"提示条形码无法识别"状态。与该转移关联的输出事件是"显示条形码无法识别"
3.1A.1, 3.1A.2: "自助借还机控制"通过"读卡器接口"向"读卡器"外部I/O设备输出"退卡"消息，完成退卡。与此同时，"自助借还机控制"对象通过"用户交互"对象向"用户键盘/显示器"对象发送"显示条形码无法识别"(包含"书籍无法识别, 请到柜台归还!")消息，提示用户书籍条形码无法识别，需要到柜台归还
3.1A.3："用户交互"向"自助借还机控制"发送"已显示条形码无法识别"消息，使得"自助借还机控制"从"提示条形码无法识别"重新回到"等待书籍识别"状态。

2A, 2A.1："用户"参与者选择取消操作，通过"用户交互"对象将"用户选择取消操作"发送给"自助借还机控制"，使得"自助借还机控制"状态图从"等待用户选择功能"转移到"退卡"状态。与该转移关联的输出事件是"退卡"和"显示已取消操作"
2A.2, 2A.3, 2A.2a, 2A.2a.1: "自助借还机控制"通过"读卡器接口"向"读卡器"外部I/O设备输出"退卡"消息，完成退卡。与此同时，"自助借还机控制"对象通过"用户交互"对象向"用户键盘/显示器"对象发送"显示已取消操作"消息，提示用户已取消功能操作
2A.4："读卡器接口"向"自助借还机控制"发送"卡已退出"消息，使得"自助借还机控制"从"退卡"重新回到"空闲状态"状态。

4A, 4A.1："用户"参与者选择取消操作，通过"用户交互"对象将"用户选择取消操作"发送给"自助借还机控制"，使得"自助借还机控制"状态图从"等待书籍识别"转移到"退卡"状态。与该转移关联的输出事件是"退卡"和"显示已取消操作"
4A.2, 4A.3, 4A.2a, 4A.2a.1: "自助借还机控制"通过"读卡器接口"向"读卡器"外部I/O设备输出"退卡"消息，完成退卡。与此同时，"自助借还机控制"对象通过"用户交互"对象向"用户键盘/显示器"对象发送"显示已取消操作"消息，提示用户已取消功能操作
4A.4："读卡器接口"向"自助借还机控制"发送"卡已退出"消息，使得"自助借还机控制"从"退卡"重新回到"空闲状态"状态。
```

### 服务端

```bash
1, 1.1, 1.2, 1.3："自助借还机"向"自助借还服务协调者"发送一个"验证校园卡是否挂失"(包含卡号)的请求，"自助借还服务协调者"根据输入决策将请求转向"验证校园卡管理器"。"验证校园卡管理器"通过"校园卡系统代理"向"校园卡系统"外部系统发送"验证校园卡是否挂失"(包含卡号)的请求
1.4, 1.5, 1.6, 1.7：若校园卡未挂失，则"校园卡系统"外部系统将"校园卡未挂失"的消息通过"校园卡系统代理"发送给"验证校园卡管理器"，再由它经过"自助借还服务协调者"将"校园卡未挂失"的消息响应给"自助借还机"客户端

2, 2.1："自助借还机"向"自助借还服务协调者"发送一个"查询书籍借阅信息"(包含书籍ISBN)的请求，"自助借还服务协调者"根据输入决策将请求转向"获取书籍借阅信息管理器"。
2.2, 2.3："获取书籍借阅信息管理器"向"书籍"实体对象请求"查询书籍信息"(包含书籍ISBN)，"书籍"实体对象向其返回"书籍信息"(包含书籍ID、书名)
2.4, 2.5："获取书籍借阅信息管理器"向"借阅记录"实体对象请求"查询书籍借阅记录"(包含书籍ID)，"借阅记录"实体对象向其返回"书籍借阅记录"(包含借阅者编号、借阅到期时间)
2.6, 2.7："获取书籍借阅信息管理器"通过"自助借还服务协调者"将"书籍借阅信息"(包含书籍ID、书名、借阅者编号、借阅到期时间)的消息响应给"自助借还机"客户端

3, 3.1："自助借还机"向"自助借还服务协调者"发送一个"更新借阅信息"(包含借阅者编号、全部的书籍ID)的请求，"自助借还服务协调者"根据输入决策将请求转向"归还管理器"。
3.2："归还管理器"向"书籍"实体对象发送"更新书籍借阅状态"(包含全部的书籍ID)的消息。每条书籍ID对应的"书籍"实体对象的借阅状态将变为"已归还"
3.2a："归还管理器"向"校园卡"实体对象发送"更新校园卡已借册数"(包含借阅者编号、全部的书籍ID)的消息。借阅者编号对应的"校园卡"实体对象的已借册数将减去书籍ID的总条数
3.2b："归还管理器"向"借阅记录"实体对象发送"更新借阅记录归还时间"(包含借阅者编号、全部的书籍ID)的消息。借阅者编号和每条书籍ID对应的所有"借阅记录"实体对象的归还时间记录为当前系统时间

1.4A, 1.A.1, 1.A.2, 1.A.3：若校园卡已挂失，则"校园卡系统"外部系统将"校园卡已挂失"的消息通过"校园卡系统代理"发送给"验证校园卡管理器"，再由它经过"自助借还服务协调者"将"校园卡已挂失"的消息响应给"自助借还机"客户端
```

